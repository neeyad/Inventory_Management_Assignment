<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>test_audit_logger.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
    <body onload="prettyPrint()">
        <h4></h4>
        <pre class="prettyprint lang-cpp linenums">
#include &lt;gtest/gtest.h&gt;
#include "AuditLogger.h"
#include &lt;fstream&gt;
#include &lt;filesystem&gt;
#include &lt;thread&gt;

<span style = "background-color:#dfd">TEST(AuditLogger, LogWrite) {
    auto&amp; logger = AuditLogger::getInstance();
    logger.log("admin", "Product", "create");
    logger.log("admin", "Category", "delete");
    std::ifstream file("logs/audit.log");
    ASSERT_TRUE(file.is_open());</span>
<span style = "background-color:#fdd">    std::string line;
    int count = 0;
    while (std::getline(file, line)) {
        if (!line.empty()) ++count;
    }
    ASSERT_GE(count, 2);
}</span>

<span style = "background-color:#dfd">TEST(AuditLogger, LogRotation) {
    auto&amp; logger = AuditLogger::getInstance();
    logger.log("admin", "SKU", "update");
    logger.rotateLogs();</span>
<span style = "background-color:#fdd">    bool foundRotated = false;
    for (const auto&amp; entry : std::filesystem::directory_iterator("logs")) {
        if (entry.path().string().find("audit_") != std::string::npos) {
            foundRotated = true;
            break;
        }
    }
    ASSERT_TRUE(foundRotated);
}</span>

<span style = "background-color:#dfd">TEST(AuditLogger, CleanupOldLogs) {
    auto&amp; logger = AuditLogger::getInstance();
    logger.cleanupOldLogs(0); // Should remove all logs older than 0 days</span>
<span style = "background-color:#fdd">    int fileCount = 0;
    for (const auto&amp; entry : std::filesystem::directory_iterator("logs")) {
        if (entry.is_regular_file()) ++fileCount;
    }
    ASSERT_LE(fileCount, 1); // Only current log may remain
}</span></pre>
        <hr />
        <table width="100%">
            <thead>
                <tr>
                    <th align="center">
                        <small>Generated by</small>
                        <a href="https://github.com/OpenCppCoverage/OpenCppCoverage/releases">
                            <strong>OpenCppCoverage (Version: 0.9.9.0)</strong>
                        </a>
                    </th>
                </tr>
            </thead>
        </table>
    </body>
</html>