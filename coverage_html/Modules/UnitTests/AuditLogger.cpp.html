<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>AuditLogger.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
    <body onload="prettyPrint()">
        <h4></h4>
        <pre class="prettyprint lang-cpp linenums">

#include "AuditLogger.h"
#include &lt;chrono&gt;
#include &lt;ctime&gt;
#include &lt;filesystem&gt;
#include &lt;mutex&gt;

<span style = "background-color:#dfd">void AuditLogger::close() {
    std::lock_guard&lt;std::mutex&gt; lock(mtx);
    if (logFile.is_open()) logFile.close();
}</span>

<span style = "background-color:#dfd">AuditLogger&amp; AuditLogger::getInstance() {
    static AuditLogger instance;
    return instance;
}</span>

<span style = "background-color:#dfd">AuditLogger::AuditLogger() {
    openLogFile();
}</span>

<span style = "background-color:#dfd">void AuditLogger::openLogFile() {
    std::filesystem::create_directories("logs");
    if (!std::filesystem::exists("logs/audit.log")) {
        std::ofstream createFile("logs/audit.log");
        createFile.close();
    }
    currentLogFileName = "logs/audit.log";
    logFile.open(currentLogFileName, std::ios::app);
}</span>

<span style = "background-color:#dfd">std::string AuditLogger::getTimestamp() const {
    auto now = std::chrono::system_clock::now();
    std::time_t now_c = std::chrono::system_clock::to_time_t(now);</span>
    char buf[32];
    // Windows: use localtime_s for thread safety
    struct tm timeinfo;
<span style = "background-color:#dfd">    localtime_s(&amp;timeinfo, &amp;now_c);
    std::strftime(buf, sizeof(buf), "%Y-%m-%d_%H-%M-%S", &amp;timeinfo); // Windows-safe
    return buf;
}</span>

<span style = "background-color:#dfd">void AuditLogger::log(const std::string&amp; user, const std::string&amp; entity, const std::string&amp; operation) {
    std::lock_guard&lt;std::mutex&gt; lock(mtx);
    if (!logFile.is_open()) openLogFile();
    logFile &lt;&lt; getTimestamp() &lt;&lt; " | " &lt;&lt; user &lt;&lt; " | " &lt;&lt; entity &lt;&lt; " | " &lt;&lt; operation &lt;&lt; std::endl;
}</span>

<span style = "background-color:#dfd">void AuditLogger::rotateLogs() {
    std::lock_guard&lt;std::mutex&gt; lock(mtx);
    logFile.close();
    std::filesystem::create_directories("logs");
    if (!std::filesystem::exists(currentLogFileName)) {</span>
<span style = "background-color:#fdd">        std::ofstream createFile(currentLogFileName);
        createFile.close();
    }</span>
<span style = "background-color:#dfd">    std::string rotatedName = "logs/audit_" + getTimestamp() + ".log";
    std::filesystem::rename(currentLogFileName, rotatedName);
    openLogFile();
}</span>

<span style = "background-color:#dfd">void AuditLogger::cleanupOldLogs(int days) {</span>
    namespace fs = std::filesystem;
<span style = "background-color:#dfd">    fs::create_directories("logs");
    if (!fs::exists("logs")) {</span>
<span style = "background-color:#fdd">        fs::create_directory("logs");</span>
    }
<span style = "background-color:#dfd">    auto now = std::chrono::system_clock::now();
    for (const auto&amp; entry : fs::directory_iterator("logs")) {
        if (entry.is_regular_file()) {
            auto ftime = fs::last_write_time(entry);</span>
            // Convert file_time_type to system_clock::time_point
<span style = "background-color:#dfd">            auto sctp = std::chrono::time_point_cast&lt;std::chrono::system_clock::duration&gt;(</span>
                ftime - decltype(ftime)::clock::now() + std::chrono::system_clock::now());
<span style = "background-color:#dfd">            auto age = std::chrono::duration_cast&lt;std::chrono::hours&gt;(now - sctp).count() / 24;
            if (age &gt; days) fs::remove(entry);
        }
    }
}</span></pre>
        <hr />
        <table width="100%">
            <thead>
                <tr>
                    <th align="center">
                        <small>Generated by</small>
                        <a href="https://github.com/OpenCppCoverage/OpenCppCoverage/releases">
                            <strong>OpenCppCoverage (Version: 0.9.9.0)</strong>
                        </a>
                    </th>
                </tr>
            </thead>
        </table>
    </body>
</html>