<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>http_listener_msg.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
    <body onload="prettyPrint()">
        <h4></h4>
        <pre class="prettyprint lang-cpp linenums">
/***
 * Copyright (C) Microsoft. All rights reserved.
 * Licensed under the MIT license. See LICENSE.txt file in the project root for full license information.
 *
 * =+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+
 *
 * HTTP Library: Request and reply message definitions (server side).
 *
 * =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
 ****/
#include "stdafx.h"

#include "../common/internal_http_helpers.h"
using namespace web;
using namespace utility;

namespace web
{
namespace http
{
// Actual initiates sending the response.
pplx::task&lt;void&gt; details::_http_request::_reply_impl(http_response response)
<span style = "background-color:#fdd">{</span>
    // If the user didn't explicitly set a reason phrase then we should have it default
    // if they used one of the standard known status codes.
<span style = "background-color:#fdd">    if (response.reason_phrase().empty())</span>
    {
<span style = "background-color:#fdd">        response.set_reason_phrase(get_default_reason_phrase(response.status_code()));</span>
    }

<span style = "background-color:#fdd">    pplx::task&lt;void&gt; response_completed;</span>

#if !defined(__cplusplus_winrt) &amp;&amp; _WIN32_WINNT &gt;= _WIN32_WINNT_VISTA
<span style = "background-color:#fdd">    auto server_api = experimental::details::http_server_api::server_api();</span>

<span style = "background-color:#fdd">    if (m_server_context &amp;&amp; server_api)</span>
    {
        // Add a task-based continuation so no exceptions thrown from the task go 'unobserved'.
<span style = "background-color:#fdd">        response._set_server_context(std::move(m_server_context));
        response_completed = server_api-&gt;respond(response);
        response_completed.then([](pplx::task&lt;void&gt; t) {</span>
            try
            {
<span style = "background-color:#fdd">                t.wait();</span>
            }
            catch (...)
<span style = "background-color:#fdd">            {
            }
        });
    }</span>
    else
#endif
    {
        // There's no server context. The message may be replied to locally, as in a HTTP client
        // pipeline stage. There's no sending required, so we can simply consider the reply
        // done and return an already filled-in task.
<span style = "background-color:#fdd">        response_completed = pplx::task_from_result();</span>
    }

<span style = "background-color:#fdd">    m_response.set(response);
    return response_completed;
}</span>

pplx::task&lt;void&gt; details::_http_request::_reply_if_not_already(status_code status)
<span style = "background-color:#fdd">{
    const long expected = 0;
    const long desired = 2;
    if (pplx::details::atomic_compare_exchange(m_initiated_response, desired, expected) == expected)</span>
    {
<span style = "background-color:#fdd">        return _reply_impl(http_response(status));</span>
    }
<span style = "background-color:#fdd">    return pplx::task_from_result();
}</span>

pplx::task&lt;void&gt; details::_http_request::reply(const http_response&amp; response)
<span style = "background-color:#fdd">{
    const long expected = 0;
    const long desired = 1;
    switch (pplx::details::atomic_compare_exchange(m_initiated_response, desired, expected))</span>
    {
<span style = "background-color:#fdd">        case 0: return _reply_impl(response); // success
        case 1: throw http_exception(U("Error: trying to send multiple responses to an HTTP request"));
        case 2: return pplx::task_from_result(); // already handled
        default: abort();</span>
    }
<span style = "background-color:#fdd">}</span>

} // namespace http
} // namespace web</pre>
        <hr />
        <table width="100%">
            <thead>
                <tr>
                    <th align="center">
                        <small>Generated by</small>
                        <a href="https://github.com/OpenCppCoverage/OpenCppCoverage/releases">
                            <strong>OpenCppCoverage (Version: 0.9.9.0)</strong>
                        </a>
                    </th>
                </tr>
            </thead>
        </table>
    </body>
</html>